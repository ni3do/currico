#!/bin/sh

# Auto-update package-lock.json if package.json was modified
if git diff --cached --name-only | grep -q "^package\.json$"; then
  echo "package.json changed, updating package-lock.json..."
  npm install --package-lock-only
  git add package-lock.json
fi

# Regenerate Prisma client if schema.prisma was modified
if git diff --cached --name-only | grep -q "^prisma/schema\.prisma$"; then
  echo "schema.prisma changed, regenerating Prisma client..."
  npx prisma generate
fi

# Run lint-staged (only when lintable files are staged)
if git diff --cached --name-only | grep -qE '\.(ts|tsx|js|jsx|json|css|md)$'; then
  npx lint-staged
fi

# Run unit tests
if [ -n "$SKIP_TESTS" ]; then
  echo "â­ï¸  Skipping unit tests (SKIP_TESTS is set)"
else
  echo "ğŸ§ª Running unit tests..."
  echo "ğŸ’¡ Tip: Set SKIP_TESTS=1 to skip: SKIP_TESTS=1 git commit"

  if npm run test:run; then
    echo "âœ… Unit tests passed"
  else
    echo "âŒ Unit tests failed. Please fix failing tests before committing."
    echo "To skip this check: SKIP_TESTS=1 git commit"
    exit 1
  fi
fi
