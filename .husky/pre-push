#!/bin/sh

# Run e2e tests (requires dev server + database)
if [ -n "$SKIP_E2E" ]; then
  echo "‚è≠Ô∏è  Skipping e2e tests (SKIP_E2E is set)"
else
  echo "üé≠ Running Playwright e2e tests (chromium-de)..."
  echo "üí° Tip: Set SKIP_E2E=1 to skip: SKIP_E2E=1 git push"

  if npx playwright test --project=chromium-de; then
    echo "‚úÖ E2e tests passed"
  else
    echo "‚ùå E2e tests failed. Please fix failing tests before pushing."
    echo "To skip this check: SKIP_E2E=1 git push"
    exit 1
  fi
fi

# Skip Docker build check if SKIP_DOCKER_CHECK is set
if [ -n "$SKIP_DOCKER_CHECK" ]; then
  echo "‚è≠Ô∏è  Skipping Docker build check (SKIP_DOCKER_CHECK is set)"
else
  echo "üê≥ Testing Docker build..."
  echo "üí° Tip: Set SKIP_DOCKER_CHECK=1 to skip this check: SKIP_DOCKER_CHECK=1 git push"

  # Test if Docker build succeeds
  if docker build -t currico-test . > /dev/null 2>&1; then
    echo "‚úÖ Docker build successful"
    # Clean up test image
    docker rmi currico-test > /dev/null 2>&1
  else
    echo "‚ùå Docker build failed. Please fix the Dockerfile before pushing."
    echo "Run 'docker build -t currico-test .' to see the error details."
    echo "To skip this check: SKIP_DOCKER_CHECK=1 git push"
    exit 1
  fi
fi

# Doc freshness check ‚Äî only runs when code paths changed and claude is installed
if command -v claude >/dev/null 2>&1; then
  DIFF=$(git diff origin/main...HEAD --stat -- 'app/' 'components/' 'lib/' 'prisma/schema.prisma' 'package.json' 'i18n/')
  if [ -n "$DIFF" ]; then
    echo "üìÑ Checking doc freshness..."
    echo "üí° Tip: Set SKIP_DOC_CHECK=1 to skip: SKIP_DOC_CHECK=1 git push"
    if [ -n "$SKIP_DOC_CHECK" ]; then
      echo "‚è≠Ô∏è  Skipping doc check (SKIP_DOC_CHECK is set)"
    else
      claude -p "You are a documentation freshness checker for the Currico project.

Here are the files changed since main:
$DIFF

Read CLAUDE.md and spec/index.md. Check if any changes would make the documentation inaccurate or incomplete.

If docs need updating, exit with code 1 and explain what needs to change.
If docs are still accurate, exit with code 0 and say 'Docs are up to date.'

Only flag genuine inaccuracies ‚Äî don't flag missing docs for minor internal changes." \
        --allowedTools 'Read,Glob,Grep' \
        --max-turns 5
    fi
  fi
fi
