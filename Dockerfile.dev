# syntax=docker/dockerfile:1

# Development Dockerfile for Next.js with hot reload
FROM node:20-alpine

# Install dependencies for native modules
RUN apk add --no-cache libc6-compat openssl

WORKDIR /app

# Development environment settings (set early, rarely changes)
ENV NODE_ENV=development
ENV NEXT_TELEMETRY_DISABLED=1
ENV WATCHPACK_POLLING=true
ENV CHOKIDAR_USEPOLLING=true

# Copy package files for dependency caching
COPY package.json package-lock.json* ./

# Install dependencies (no cache to ensure correct versions)
RUN npm cache clean --force && npm ci

# Copy Prisma schema and config, generate client
COPY prisma ./prisma/
COPY prisma.config.ts ./
RUN ./node_modules/.bin/prisma generate && \
    echo "Prisma version:" && ./node_modules/.bin/prisma --version

# Note: Source code is mounted as volume in docker-compose.yml
# No need to COPY . . since it would be overwritten anyway

EXPOSE 3000

# Install deps at runtime (volume mount creates empty node_modules), sync DB, seed, and start
CMD ["sh", "-c", "npm install && ./node_modules/.bin/prisma generate && ./node_modules/.bin/prisma db push --accept-data-loss && ./node_modules/.bin/prisma db seed && npm run dev"]
